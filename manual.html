<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <title>Vibecheck ‚Äì Manuell</title>

    <script>
        const token = sessionStorage.getItem("spotify_access_token");
        const mode = sessionStorage.getItem("selected_mode");
        if (!token) window.location = "auth.html";
        if (mode !== "manual") window.location = "start.html";
    </script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #050816;
            color: #e5e7eb;
            padding: 2rem;
        }
        a { color: #3b82f6; text-decoration: none; }

        .row {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 1.25rem;
            align-items: start;
            margin-top: 1rem;
        }
        .card {
            background: #020617;
            border: 1px solid #0f172a;
            border-radius: 1rem;
            padding: 1.25rem;
        }
        .btn {
            background: #0f172a;
            color: #e5e7eb;
            border: 1px solid #1f2a44;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-weight: 700;
        }
        .btn:disabled { opacity: .6; cursor: not-allowed; }

        .muted { color: #9ca3af; }
        video {
            width: 100%;
            border-radius: 0.75rem;
            background: #000;
            border: 1px solid #0f172a;
        }
        .big { font-size: 1.1rem; font-weight: 800; margin: .25rem 0 .75rem 0; }
        .pill {
            display: inline-block;
            padding: .25rem .5rem;
            border-radius: 999px;
            background: #0f172a;
            color: #9ca3af;
            font-size: .8rem;
            margin-left: .5rem;
        }

        .player { display: grid; grid-template-columns: 96px 1fr; gap: 1rem; align-items: center; }
        #trackImage {
            width: 96px; height: 96px; object-fit: cover;
            border-radius: 0.75rem; border: 1px solid #0f172a; background: #000;
        }
        .controls { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.75rem; }
        .timeline { display:grid; grid-template-columns:56px 1fr 56px; gap:.75rem; align-items:center; margin-top:.75rem; }
        input[type="range"] { width:100%; }

        pre {
            white-space: pre-wrap;
            background: #000814;
            border: 1px solid #0f172a;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-top: 1rem;
            max-height: 260px;
            overflow: auto;
        }

        @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
    </style>
</head>

<body>
<a href="start.html" onclick="sessionStorage.removeItem('selected_mode')">‚Üê Zur√ºck zur Modus-Auswahl</a>

<h1 style="margin: .75rem 0 0 0;">Vibecheck ‚Äì Manuelle Emotion</h1>
<p class="muted" style="margin: .25rem 0 1rem 0;">
    Dr√ºcke den Button, zeige 5 Sekunden eine Emotion ‚Äì danach wird die passende Playlist gestartet und bleibt aktiv bis zur n√§chsten Messung.
    <span class="pill">Modus: Manual</span>
</p>

<div class="row">
    <div class="card">
        <div class="big">Kamera</div>
        <video id="video" autoplay muted playsinline></video>

        <div style="margin-top: 1rem;">
            <button class="btn" id="measureBtn">üé≠ Emotion messen (5s)</button>
            <div class="muted" id="measureStatus" style="margin-top: .5rem;">Status: bereit</div>
        </div>

        <div class="muted" style="margin-top: .75rem;">
            Tipp: Gesicht gut im Bild halten und 5 Sekunden konstant bleiben.
        </div>
    </div>

    <div class="card">
        <div class="big">Player</div>

        <div class="player">
            <img id="trackImage" alt="cover" />
            <div>
                <div id="trackTitle" style="font-weight: 900;">‚Äî</div>
                <div id="trackArtist" class="muted">‚Äî</div>

                <div class="controls">
                    <button class="btn" id="prevBtn" disabled>‚èÆÔ∏è</button>
                    <button class="btn" id="startBtn" disabled>‚ñ∂Ô∏è</button>
                    <button class="btn" id="nextBtn" disabled>‚è≠Ô∏è</button>

                    <span class="muted">Lautst√§rke:</span>
                    <input id="volumeSlider" type="range" min="0" max="100" value="50" disabled />
                    <span id="volumeValue" class="muted">50%</span>
                </div>

                <div class="timeline">
                    <div id="currentTime" class="muted">0:00</div>
                    <input id="progressBar" type="range" min="0" max="1" value="0" />
                    <div id="durationTime" class="muted">0:00</div>
                </div>
            </div>
        </div>

        <pre id="log"></pre>
    </div>
</div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>

<script defer src="face-api.min.js"></script>
<script defer src="camera.js"></script>
<script defer src="app.js"></script>

<script>
    const measureBtn = document.getElementById("measureBtn");
    const statusEl = document.getElementById("measureStatus");
    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

    async function doManualMeasurement() {
        if (!sessionStorage.getItem("spotify_access_token")) {
            window.location = "auth.html";
            return;
        }
        if (typeof window.resetEmotionStats !== "function" || typeof window.getDominantEmotion !== "function") {
            statusEl.textContent = "Status: Kamera/Emotion-Module nicht bereit (camera.js?)";
            return;
        }
        if (typeof window.applyEmotionNow !== "function") {
            statusEl.textContent = "Status: Player nicht bereit (app.js?)";
            return;
        }

        measureBtn.disabled = true;
        window.resetEmotionStats();

        for (let i = 5; i >= 1; i--) {
            statusEl.textContent = `Status: messen... (${i}s)`;
            await sleep(1000);
        }

        const dominant = window.getDominantEmotion();
        if (!dominant) {
            statusEl.textContent = "Status: keine Emotion erkannt ‚ùå (bitte erneut versuchen)";
            measureBtn.disabled = false;
            return;
        }

        statusEl.textContent = `Status: erkannt ‚Üí ${dominant} ‚úÖ (Playlist wird gesetzt)`;
        await window.applyEmotionNow(dominant);

        statusEl.textContent = "Status: bereit";
        measureBtn.disabled = false;
    }

    measureBtn.addEventListener("click", doManualMeasurement);
</script>
</body>
</html>
