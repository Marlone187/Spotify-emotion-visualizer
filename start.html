<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Vibecheck</title>

  <script>
    if (!sessionStorage.getItem("spotify_access_token")) {
      window.location = "auth.html";
    }
  </script>

  <link rel="stylesheet" href="styles.css" />
</head>

<body class="is-start">

<main class="start-wrap">
  <h1 class="start-title">Vibecheck</h1>

  <section class="mode-grid">
    <button class="mode-card" onclick="
        sessionStorage.setItem('selected_mode','manual');
        window.location='manual.html';
      ">
      <span class="mode-pill">MANUELL</span>
      <h2 class="mode-name">Manuelle Emotion</h2>
      <p class="mode-mini">Emotionsmessung bei Klick.</p>
    </button>

    <button class="mode-card" onclick="
        sessionStorage.setItem('selected_mode','auto');
        window.location='index.html';
      ">
      <span class="mode-pill">AUTO</span>
      <h2 class="mode-name">Automatische Emotion</h2>
      <p class="mode-mini">Automatische Erkennung während Songs.</p>
    </button>
  </section>

  <details id="playlistDetails" class="start-details">
    <summary>
      <span>Playlists anpassen</span>
      <span class="chev" aria-hidden="true"></span>
    </summary>

    <div class="details-body">


      <div class="start-inputs">
        <div class="start-input-row">
          <label><span class="label-happy">HAPPY</span></label>
          <input id="pl_happy" placeholder="Playlist Link/URI (optional)" />
        </div>

        <div class="start-input-row">
          <label><span class="label-sad">SAD</span></label>
          <input id="pl_sad" placeholder="Playlist Link/URI (optional)" />
        </div>

        <div class="start-input-row">
          <label><span class="label-neutral">NEUTRAL</span></label>
          <input id="pl_neutral" placeholder="Playlist Link/URI (optional)" />
        </div>

        <div class="start-input-row">
          <label><span class="label-angry">ANGRY</span></label>
          <input id="pl_angry" placeholder="Playlist Link/URI (optional)" />
        </div>
      </div>

      <div class="start-rowBtns">
        <button class="start-btn" id="savePlaylistsBtn">Speichern</button>
        <button class="start-btn" id="loadPlaylistsBtn">Neu laden</button>
        <button class="start-btn danger" id="resetPlaylistsBtn">Default</button>
        <span id="playlistStatus" class="start-status"></span>
      </div>
    </div>
  </details>

  <span class="start-logout" onclick="
      sessionStorage.removeItem('spotify_access_token');
      sessionStorage.removeItem('code_verifier');
      sessionStorage.removeItem('selected_mode');
      window.location='auth.html';
    ">
      Logout / neu verbinden
    </span>
</main>

<script>
  const inputs = {
    happy: document.getElementById("pl_happy"),
    sad: document.getElementById("pl_sad"),
    neutral: document.getElementById("pl_neutral"),
    angry: document.getElementById("pl_angry"),
  };

  const statusEl = document.getElementById("playlistStatus");
  const detailsEl = document.getElementById("playlistDetails");

  function toPlaylistUri(value){
    if(!value) return "";
    const v = value.trim();
    if(v.startsWith("spotify:playlist:")) return v;
    const m = v.match(/open\.spotify\.com\/playlist\/([a-zA-Z0-9]+)(\?|$)/);
    if(m && m[1]) return `spotify:playlist:${m[1]}`;
    return "";
  }

  function loadFromStorage(){
    const raw = localStorage.getItem("custom_playlists");
    if(!raw) return null;
    try{ return JSON.parse(raw); } catch{ return null; }
  }

  function writeInputsFromStorage(){
    const saved = loadFromStorage();
    const data = saved || {};
    inputs.happy.value = data.happy_link || "";
    inputs.sad.value = data.sad_link || "";
    inputs.neutral.value = data.neutral_link || "";
    inputs.angry.value = data.angry_link || "";

    statusEl.textContent = saved ? "Custom-Playlists geladen." : "Default-Playlists aktiv.";
  }

  function saveToStorage(){
    const happy_link = inputs.happy.value.trim();
    const sad_link = inputs.sad.value.trim();
    const neutral_link = inputs.neutral.value.trim();
    const angry_link = inputs.angry.value.trim();

    const parsed = {
      happy_uri: toPlaylistUri(happy_link),
      sad_uri: toPlaylistUri(sad_link),
      neutral_uri: toPlaylistUri(neutral_link),
      angry_uri: toPlaylistUri(angry_link),
      happy_link, sad_link, neutral_link, angry_link
    };

    const invalids = [];
    if(happy_link && !parsed.happy_uri) invalids.push("HAPPY");
    if(sad_link && !parsed.sad_uri) invalids.push("SAD");
    if(neutral_link && !parsed.neutral_uri) invalids.push("NEUTRAL");
    if(angry_link && !parsed.angry_uri) invalids.push("ANGRY");

    if(invalids.length){
      statusEl.textContent = "Ungültig: " + invalids.join(", ");
      return;
    }

    const allEmpty = !happy_link && !sad_link && !neutral_link && !angry_link;
    if(allEmpty){
      localStorage.removeItem("custom_playlists");
      statusEl.textContent = "Alles leer → Default aktiv.";
      detailsEl.open = false;
      return;
    }

    localStorage.setItem("custom_playlists", JSON.stringify(parsed));
    statusEl.textContent = "Gespeichert";
    detailsEl.open = false;
  }

  function resetToDefault(){
    localStorage.removeItem("custom_playlists");
    inputs.happy.value = "";
    inputs.sad.value = "";
    inputs.neutral.value = "";
    inputs.angry.value = "";
    statusEl.textContent = "Zurückgesetzt → Default aktiv.";
    detailsEl.open = false;
  }

  document.getElementById("savePlaylistsBtn").addEventListener("click", saveToStorage);
  document.getElementById("loadPlaylistsBtn").addEventListener("click", writeInputsFromStorage);
  document.getElementById("resetPlaylistsBtn").addEventListener("click", resetToDefault);

  writeInputsFromStorage();
</script>

</body>
</html>
